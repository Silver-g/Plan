# План проекта: Калькулятор инвестиционного портфеля

## Общее описание

**Краткое описание проекта**: Калькулятор инвестиционного портфеля — это приложение для брокеров, позволяющее организовывать и отслеживать стоимость персонального портфеля ценных бумаг (акции, облигации) с актуальной информацией о ценах и доходности.

**Потенциальный пользователь**: Брокеры

**Решаемая проблема**: Упрощение управления портфелем ценных бумаг, предоставление актуальной информации о стоимости и доходности для принятия торговых решений.

**Польза**: Удобный интерфейс, позволяющий:
- Регистрироваться и аутентифицироваться.
- Выбирать, добавлять и удалять ценные бумаги из портфеля.
- Получать информацию о текущей стоимости портфеля, дивидендах и купонах в реальном времени (или с частым обновлением).
- Отслеживать ключевые метрики для торговли (цены, доходность).

**Если кратко** то по сути это калькулятор ценных бумаг где пользователь может, зарегистрироваться, выбирать ценные бумаги из пула и добавлять и удалять их из портфеля, пользователь будет получать информацию по дивидендам и номинальной стоимости портфеля при этом информация должна часто обновляться, так как предполагается что эту информацию пользователь использует для торговли (покупки/продажи ценных бумаг).

## Цели проекта

**Личные цели разработчика**:
- Освоить микросервисную архитектуру.
- Поработать с Redis (кэширование), разобраться с gRPC (межсервисное взаимодействие), разобраться с Kafka.
- Порабоать с контекстными операциями.
- Научиться проектировать архитектуру приложения.
- Реализовать API с поддержкой реал-тайм данных (если возможно).
- Минимально проработать систему логирования.
- Соблюдать best practices и писать чистый код.

**Основная цель**: освоение новых для меня технологий, поиск сложностей и потенциальных слабых мест и их изучение/устранение. 

## Видение проекта

Проект как я его вижу: реализация взаимодействия с внешнем апи, написание логики калькулятора, проектирование хранения и быстрого получения актуальных данных, регистрация, логика работы с портфелем. 

## Архитектура: Микросервисы

| Сервис                      | Описание                                                                |
|-----------------------------|-------------------------------------------------------------------------|
| Сервис регистрации          | Управление пользователями (регистрация, аутентификация).                |
| Сервис работы с портфелем   | Создание, изменение, удаление портфелей, добавление/удаление бумаг.     |
| Сервис взаимодействия с API | Получение данных о ценных бумагах с Московской биржи.                   |
| Сервис калькулятора         | Расчёт стоимости портфеля, дивидендов, купонных выплат.                 |

**Gateway**: API-шлюз, распределяющий запросы между сервисами через gRPC. Выполняет базовую валидацию и маршрутизацию.

## Use-cases

1. **Добавление ценной бумаги в портфель**:
   - Пользователь отправляет запрос через UI.
   - Gateway маршрутизирует запрос в сервис работы с портфелем (gRPC).
   - Сервис проверяет наличие бумаги в БД:
     - Если бумага есть, добавляет её в портфель.
     - Если нет, запрашивает данные у сервиса взаимодействия с API Мосбиржи.
   - Сервис API получает данные (SECID, имя, цена, дивиденды/купоны) и сохраняет в БД.
   - Сервис портфеля обновляет портфель и возвращает ответ клиенту.

2. **Получение текущей стоимости портфеля**:
   - Пользователь запрашивает стоимость через UI (в идеале — в реальном времени).
   - Gateway отправляет запрос в сервис работы с портфелем.
   - Сервис портфеля получает список бумаг из БД и запрашивает актуальные цены через сервис API.
   - Сервис API возвращает текущие цены (из кэша или API Мосбиржи).
   - Сервис калькулятора вычисляет стоимость портфеля и возвращает данные клиенту.

## Технические детали

### API Gateway
- **Функции**: Маршрутизация запросов, базовая валидация (формат, токены), rate limiting.
- **Технология**: gRPC для межсервисного взаимодействия, REST для клиентских запросов.
- **Предположение**: Gateway знает эндпоинты всех сервисов и распределяет запросы, возможно он же валидирует входящие запросы (пустые поля и тд). Или это делает отдельный сервис (но как мне кажется это было бы странно)

### База данных
- **Основная БД**: PostgreSQL, вопрос в том нужна ли отдельная бд для сервиса регистрации и условно отдельная бд для логики остального приложения? Я слышал, что в микро сервисной архитектуре у каждого сервиса своя бд, но мне кажется в моем случае это избыточно я бы делал просто разные таблицы. 
- **Кэш**: Redis В кеше я храню чисто инфу по самой акции имя, описание и тд, не понятно нужно ли хранить какую то номинальную стоимость я думаю, что нет, но теоретически предполагаю, что может понадобится например если какой либо сервис упадет нужно вернуть же какую то инфу клиенту или обрабатывать это вообще, как отдельный случай тут не понятно. 

#### Схема данных

**Таблица: users**

| Поле            | Описание                              |
|-----------------|---------------------------------------|
| user_id         | Уникальный идентификатор (UUID)       |
| login           | Логин пользователя                    |
| password_hash   | Хэш пароля (bcrypt/argon2)            |

**Таблица: Share (Акция)**

| Поле               | Описание                                         |
|--------------------|--------------------------------------------------|
| secid              | Уникальный код ценной бумаги (например, SBER)    |
| type               | Тип бумаги: stock, bond                          |
| name               | Название бумаги (например, "Сбербанк")           |
| face_value         | Номинальная стоимость (руб.)                     |
| last_price         | Текущая рыночная цена                            |
| dividend_amount    | Размер дивидендов (руб., для акций)              |
| updated_at         | Время последнего обновления (опционально)        |

**Таблица: portfolios (сам портфель)**

| Поле          | Описание                              |
|---------------|---------------------------------------|
| portfolio_id  | Уникальный идентификатор (UUID)       |
| user_id       | ID пользователя (FK)                  |
| name          | Название портфеля                     |

**Таблица: holdings (формируем портфель)**

| Поле          | Описание                              |
|---------------|---------------------------------------|
| holding_id    | Уникальный идентификатор (UUID)       |
| portfolio_id  | ID портфеля (FK)                      |
| secid         | Код ценной бумаги (FK)                |
| quantity      | Количество бумаг                      |

**Примечание**: для каждого вида ценных бумаг вероянтно нужна своя таблицатак как нужны разные поля напрмиер:
- **Таблица Акций:** Код ценной бумаги (акция сбера SBER), имя, описание, текущая рыночная стоимость, дивиденды, описание, дата следующей выплаты дивидендов ~примерное описание
- **Для облигации:** Код ценной бумаги (облигация сбера RU000A0ZZBN9), имя, описание (опционально), номинальная стоимость, текущая рыночная стоимость, величина купона (размер периодических выплат за владение), периодичность выплат (например 91 значит раз в 3 месяца), дата следующий выплаты, дата погашения купона ~примерное описание


## Что мне особенно не понятно.
1. Где и как валидировать запросы взаимодействия с портфелем, нужен ли отдельный сервис валидации?
2. Какую информацию логировать и где это хранить? 
3. Верный ли набор сервисов я выбрал?
4. Нужна ли какая либо доп безопасность? Как никак с деньгами работаем
5. Нужно ли и если да как реализовать постоянную актуализацию инфы по портфелю на странице?
6. Норм ли схема данных?

