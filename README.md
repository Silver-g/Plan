# План проекта: Калькулятор инвестиционного портфеля

## Общее описание

**Краткое описание проекта**: Калькулятор инвестиционного портфеля — это приложение для брокеров, позволяющее организовывать и отслеживать стоимость персонального портфеля ценных бумаг (акции, облигации) с актуальной информацией о ценах и доходности.

**Потенциальный пользователь**: Брокеры

**Решаемая проблема**: Упрощение управления портфелем ценных бумаг, предоставление актуальной информации о стоимости и доходности для принятия торговых решений.

**Польза**: Удобный интерфейс, позволяющий:
- Регистрироваться и аутентифицироваться.
- Выбирать, добавлять и удалять ценные бумаги из портфеля.
- Получать информацию о текущей стоимости портфеля, дивидендах и купонах в реальном времени (или с частым обновлением).
- Отслеживать ключевые метрики для торговли (цены, доходность).

**Если кратко** то по сути это калькулятор ценных бумаг где пользователь может, зарегистрироваться, выбирать ценные бумаги из пула и добавлять и удалять их из портфеля, пользователь будет получать информацию по дивидендам и номинальной стоимости портфеля при этом информация должна часто обновляться, так как предполагается что эту информацию пользователь использует для торговли (покупки/продажи ценных бумаг).

## Цели проекта

**Личные цели**:
- Освоить микросервисную архитектуру.
- Поработать с Redis (кэширование), разобраться с gRPC (межсервисное взаимодействие), разобраться с Kafka.
- Порабоать с контекстными операциями.
- Научиться проектировать архитектуру приложения.
- Реализовать API с поддержкой реал-тайм данных (если возможно).
- Минимально проработать систему логирования.
- Соблюдать best practices и писать чистый код.

**Основная цель**: освоение новых для меня технологий, поиск сложностей и потенциальных слабых мест и их изучение/устранение. 

## Видение проекта

Проект как я его вижу: реализация взаимодействия с внешнем апи, написание логики калькулятора, проектирование хранения и быстрого получения актуальных данных, регистрация, логика работы с портфелем. 

## Архитектура: Микросервисы

| Сервис                      | Описание                                                                |
|-----------------------------|-------------------------------------------------------------------------|
| Сервис регистрации          | Управление пользователями (регистрация, аутентификация).                                                                                   |
| Сервис работы с портфелем   | Создание, изменение, удаление портфелей, добавление/удаление бумаг. + Калькулятор (Расчёт стоимости портфеля, дивидендов, купонных выплат.)|
| Сервис взаимодействия с API | Получение данных о ценных бумагах с Московской биржи.                                                                                      |

**Gateway**: API-шлюз, распределяющий запросы между сервисами через gRPC. Выполняет маршрутизацию.

## Use-cases
Пользователь на стороне клиента имеет список акций, он обновляется раз в сутки. Для запроса на добавление акции в портфель не нужно знать цену нужно просто знать ее спец айди. 

1. **Добавление ценной бумаги в портфель**:
   - Пользователь отправляет запрос через UI.
   - Gateway маршрутизирует запрос в сервис работы с портфелем (gRPC).
   - Сервис проверяет валидность значения идентификатора через пул в кеше. 
     - Если валидно, добавляет её идентификатора в портфель. Акиульность пула в кеше поддерживаем с помощью cron-job раз в сутки условно. 
     - Если нет, выводим сообщение об ошибке.
   - Сервис портфеля обновляет портфель и возвращает ответ клиенту.
   - Ремарка: Портфель НЕ хранит данные о акции поля с ценой описанием и тд, он просто содержит спец айдишник и все порфтель просто представляет набор спец айдишников и колличесвта акций. Условно Поле: спец-айди SBER, поле колличество 500. Значит 500 акций сбеа в этом порфтеле.

2. **Получение текущей стоимости портфеля**:
   - Пользователь запрашивает стоимость через UI (в идеале — в реальном времени).
   - Gateway отправляет запрос в сервис работы с портфелем.
   - Сервис портфеля получает список бумаг из БД и запрашивает актуальные цены через сервис API.
   - Сервис API возвращает текущие цены (из кэша или API Мосбиржи).
   - Сервис калькулятора вычисляет стоимость портфеля и возвращает данные клиенту.
   - Ремарка: данные о цене держим в кеше обновляем раз в минуту условно. Тут не очень уверен но пока так. 
3. **Получение стоимости ценной бумаги**:
   - cron job к апи мос биржы для обнолвения цен в кеше раз в 5 сек.
   - Составной get запрос для всех видимых акций на стороне клиента, условно 20 акций на странице. 
   - short polling - на стороне клиента, каждые 5 сек
   - Очевидно тянем все из кеша чтобы поддерживать адекватную скокрость обработки при большой нагрузке
4. **Получение списка ценных бумаг**:
   - Обновления списка ценных бумаг в кеше через cron job (раз в сутки), запрос к апи биржы
   - Клиент делает обычный get запрос на получение списка акций, spec id + имя 
   - Акции подтягиваются из кеша и сервер возвращают срез акций на клиент
**Вопросы** по этому разделу
   - Вопрос: Как реализовать cron job? Какой способ реализации cron job использовать системный или програмнный (слышал что можно отделньый бинарник запускать с определенным интервалом)? Я сам думаю что делать это через горутины с бесконечным циклом и условным time sleap раз в такое то время, нейкронка подсказала про то что есть системные cron job`ы а еще то что есть библа для их настройки. Как у вас это делают?
```go
// упрощенный пример того о чем писал выше
func main() {
    go func() {
        for {
            fmt.Println("Работаю в фоне")
            time.Sleep(time.Second) // время делея 
        }
    }()
}
``` 
   - Вопроc: Нужно ли оптимизировать 3ий use case? Я думаю что да. Нужно наверноне от cron job которая обновляет цены посылать в логи или брокер сообщений или еще как то флаг о том что были измнения или нет, если нет не идти в кеш и просто писать клиенту not change или типо того. Просто задумался над тем нужно ли оптизировать колличество запросов к кешу. Чисто теоритически моя идея избыточно интересно какие у тебя мысли на этот счет. 

Надеюсь я верно понял твои вопросы 1 и 2 и дал на них верный ответ. Почему тащу акции из бд? Как пользователь будет узнавать, какие акции существуют?  Ты права бд вообще не нжуно в кеше хранить условный список спец id ценной бумаги и этого будет достаточно. При заходе на страницу клиент будет получать срез спец айдишников и при помощи их уже взаимодейстовать с апи дальше. И обновлять список раз в какое то время. Чтобы узнать цену сделаем то что описал 3 use case аякс запрос от клиента с интервалом в 5 сек. 

Мб объеднить 3 и 4 пункт в палне cron job обновлять и список акций и цены сразу раз в 10 сек условно.

## Технические детали

### API Gateway
- **Функции**: Маршрутизация запросов, базовая валидация (формат, токены), rate limiting.
- **Технология**: gRPC для межсервисного взаимодействия, REST для клиентских запросов.
- **Предположение**: Gateway знает эндпоинты всех сервисов и распределяет запросы.

### База данных
- **Postgres**: таблица пользователй, портфели
- **Кэш**: Redis храню список сец айди и назвний + цены

#### Схема данных

**Таблица: users** это постгря

| Поле            | Описание                              |
|-----------------|---------------------------------------|
| user_id         | Уникальный идентификатор (UUID)       |
| login           | Логин пользователя                    |
| password_hash   | Хэш пароля (bcrypt/argon2)            |

**Таблица: Share (Акция)** это кеш 

| Поле               | Описание                                         |
|--------------------|--------------------------------------------------|
| secid              | Уникальный код ценной бумаги (например, SBER) (раз в сутки)    |
| name               | Название бумаги (например, "Сбербанк") (раз в сутки)           |
| face_value         | Номинальная стоимость (руб.) (раз в сутки)                     |
| last_price         | Текущая рыночная цена  (раз в 5 сек)                           |
| dividend_amount    | Размер дивидендов (руб., для акций)    (раз в сутки)           |
| updated_at         | Время последнего обновления (опционально)                      |

p.s додлать таблицу с учетом особенностей торгов акций
Я решил для каждого вида ценных бумаг делать свою таблицу / список
**Таблица: portfolios (сам портфель)** это постгря

| Поле          | Описание                              |
|---------------|---------------------------------------|
| portfolio_id  | Уникальный идентификатор (UUID)       |
| user_id       | ID пользователя (FK)                  |
| name          | Название портфеля                     |

**Таблица: holdings (формируем портфель)** это постгря

| Поле          | Описание                              |
|---------------|---------------------------------------|
| holding_id    | Уникальный идентификатор (UUID)       |
| portfolio_id  | ID портфеля (FK)                      |
| secid         | Код ценной бумаги (FK)                |
| quantity      | Количество бумаг                      |



